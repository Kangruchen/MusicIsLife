# 细分节拍使用指南

## 概述

现在铺面系统已支持**半拍、三连音**等不在整拍上的音符。音符的 `beat_number` 字段现在使用浮点数表示，可以精确到任意节拍细分。

## 支持的节拍类型

### 1. 整拍（1/1）
正常的整数节拍，如第1拍、第2拍等。

```json
{"beat": 1.0, "type": "HIT"}
{"beat": 2.0, "type": "GUARD"}
```

### 2. 半拍（1/2）
每拍分为两个半拍。

```json
{"beat": 1.0, "type": "HIT"}
{"beat": 1.5, "type": "GUARD"}  // 第1拍的后半拍
{"beat": 2.0, "type": "DODGE"}
{"beat": 2.5, "type": "HIT"}    // 第2拍的后半拍
```

### 3. 三连音（1/3）
每拍分为三个部分。

```json
{"beat": 1.0, "type": "HIT"}
{"beat": 1.333, "type": "GUARD"}  // 第1个三连音
{"beat": 1.667, "type": "DODGE"}  // 第2个三连音
{"beat": 2.0, "type": "HIT"}
```

### 4. 四分音（1/4）
每拍分为四个部分。

```json
{"beat": 1.0, "type": "HIT"}
{"beat": 1.25, "type": "GUARD"}   // 第1个四分音
{"beat": 1.5, "type": "DODGE"}    // 半拍
{"beat": 1.75, "type": "HIT"}     // 第3个四分音
{"beat": 2.0, "type": "GUARD"}
```

### 5. 更复杂的节奏
你可以使用任意浮点数来表示更复杂的节奏。

```json
{"beat": 1.0, "type": "HIT"}
{"beat": 1.125, "type": "GUARD"}  // 八分音符
{"beat": 1.625, "type": "DODGE"}  // 不规则节奏
{"beat": 2.0, "type": "HIT"}
```

## JSON 铺面示例

```json
{
  "chart_name": "节奏复杂的铺面",
  "music_path": "res://music/example.mp3",
  "bpm": 120.0,
  "offset": 0.0,
  "notes": [
    {"beat": 0.0, "type": "HIT"},
    {"beat": 0.5, "type": "HIT"},      // 半拍
    {"beat": 1.0, "type": "GUARD"},
    {"beat": 1.333, "type": "DODGE"},  // 三连音
    {"beat": 1.667, "type": "HIT"},    // 三连音
    {"beat": 2.0, "type": "GUARD"},
    {"beat": 2.25, "type": "HIT"},     // 四分音
    {"beat": 2.5, "type": "DODGE"},    // 半拍
    {"beat": 2.75, "type": "GUARD"},   // 四分音
    {"beat": 3.0, "type": "HIT"}
  ]
}
```

## StepMania (.sm) 文件支持

StepMania 格式本身就支持细分节拍。系统会自动根据每个小节的行数计算正确的节拍位置。

例如，如果一个小节有8行，每行代表半拍：
```
0000
1000  // 第0拍
0100  // 第0.5拍
0000
0010  // 第1拍
0000
0001  // 第1.5拍
0000  // 第2拍
,
```

如果一个小节有12行，每行代表三分之一拍：
```
1000  // 第0拍
0000
0000
0100  // 第0.333拍
0000
0000
0010  // 第0.667拍
0000
0000
0001  // 第1拍
0000
0000  // ...以此类推
,
```

## 技术细节

### 浮点数精度
系统使用浮点数比较时会允许小误差（0.001），因此以下写法都是等价的：
- `1.333` ≈ `1.33333`
- `1.667` ≈ `1.66667`

### 节拍计算公式
```gdscript
beat_time = chart.offset + beat_number * beat_interval
beat_interval = 60.0 / bpm
```

### 注意事项
1. **节拍编号从0开始**：第一个音符应该在 `beat: 0.0`
2. **浮点数精度**：建议使用最多3位小数，如 `1.333` 而不是 `1.33333333`
3. **节拍对齐**：确保音符的节拍位置与音乐的节奏对齐，可以使用音频编辑软件辅助确定

## 实践建议

1. **从简单开始**：先使用整拍和半拍，熟悉后再尝试三连音等复杂节奏
2. **使用计算器**：对于三连音（1/3）、五连音（1/5）等，使用计算器计算精确的浮点数值
3. **测试播放**：创建铺面后在游戏中测试，确保节奏准确
4. **参考音频**：使用音频编辑软件（如Audacity）查看波形，帮助确定准确的节拍位置
